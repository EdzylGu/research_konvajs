<!DOCTYPE html>
<html>

<head>
  <script src="./konva.min.js"></script>
  <meta charset="utf-8">
  <title>Konva Modify Curves with Anchor Points Demo</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #F0F0F0;
    }
  </style>
</head>

<body>
  <div id="container"></div>
  <script>
    var width = window.innerWidth;
    var height = window.innerHeight;

    // globals
    var curveLayer, lineLayer, anchorLayer, quad, points=[], lines=[];

    function updateDottedLines() {

      lineLayer.draw();
    }

    function buildAnchor(x, y) {
      var anchor = new Konva.Circle({
        x: x,
        y: y,
        radius: 10,
        stroke: '#666',
        fill: '#ddd',
        strokeWidth: 2
      });

      // add hover styling
      anchor.on('mouseover', function() {
        document.body.style.cursor = 'pointer';
        this.setStrokeWidth(4);
        anchorLayer.draw();
      });
      anchor.on('mouseout', function() {
        document.body.style.cursor = 'default';
        this.setStrokeWidth(2);
        anchorLayer.draw();

      });

      anchor.on('dragend', function() {
        updateDottedLines();
      });

      anchorLayer.add(anchor);
      return anchor;
    }

    var stage = new Konva.Stage({
      container: 'container',
      width: width,
      height: height
    });

    anchorLayer = new Konva.Layer();
    lineLayer = new Konva.Layer();

    var start_x = 100, start_y = 100;
    for (var i = 0; i < 10; i++) {
      var points_temp = [];
      for (var j = 0; j < 10; j++) {
        points_temp[j] = buildAnchor(start_x + 40*i, start_y+40*j);
      }
      points[i] = points_temp;
    }
    console.log(points);
    for (var i = 0; i < points.length-1; i++) {
      for (var j = 0; j < points[i].length; j++) {
        var line = [];
        line.push(points[i][j].attrs.x,points[i][j].attrs.y, points[i+1][j].attrs.x, points[i+1][j].attrs.y);
        console.log(line);
        lines.push(new Konva.Line({
          strokeWidth: 3,
          stroke: 'black',
          lineCap: 'round',
          id: 'quadLine',
          opacity: 0.3,
          points: line
        }));
      }
    }
    for (var i = 0; i < points.length; i++) {
      for (var j = 0; j < points[i].length - 1; j++) {
        var line = [];
        line.push(points[i][j].attrs.x,points[i][j].attrs.y, points[i][j+1].attrs.x, points[i][j+1].attrs.y);
        console.log(line);
        lines.push(new Konva.Line({
          strokeWidth: 3,
          stroke: 'black',
          lineCap: 'round',
          id: 'quadLine',
          opacity: 0.3,
          points: line
        }));
      }
    }

    // add dotted line connectors
    for (var i = 0; i < lines.length; i++) {
      lineLayer.add(lines[i]);
    }
    // keep curves insync with the lines
    anchorLayer.on('beforeDraw', function() {
      updateDottedLines();
    });


    stage.add(lineLayer);
    stage.add(anchorLayer);
    updateDottedLines();
  </script>

</body>

</html>
